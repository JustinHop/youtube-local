#! /bin/bash

if [[ $1 = "--help" ]] || [[ $1 = "help" ]]; then
  echo "Indent videos file generated by youtube-local"
  echo "To be use on a range of videos"
  echo ""
  echo "Example (in vim):"
  echo "Select all videos (normal mode): gg v G"
  echo ":'<,'> !~/path/youtube-local/bin/align-videos.sh"
  exit
fi

TMP_FILE=~/tmp/indent-vids-tmp
LONGEST_CHANNEL=0
LONGEST_NAME=0

while read line
do
  # Save to file, easier to work with than in var
  echo "$line" >> $TMP_FILE

  CHANNEL=$(echo "$line" | perl -n -e'/^([^:]*):/ && print $1')
  if [[ ${#CHANNEL} -gt $LONGEST_CHANNEL ]]; then
    LONGEST_CHANNEL=${#CHANNEL}
  fi

  NAME=$(echo "$line" | perl -n -e'/:\s+(.*?)\s+http/ && print $1' | sed -e 's/[[:space:]]*$//' )
  if [[ ${#NAME} -gt $LONGEST_NAME ]]; then
    LONGEST_NAME=${#NAME}
  fi
done < "${1:-/dev/stdin}"

while read line;
do
  if [[ -n "$line" ]]; then
    CHANNEL=$(echo "$line" | perl -n -e'/^([^:]*):/ && print $1')
    NAME=$(echo "$line" | perl -n -e'/:\s+(.*?)\s+http/ && print $1' | sed -e 's/[[:space:]]*$//' )
    URL=$(echo "$line" | perl -n -e'/\s+(http.*)/ && print $1')

    PAD=$(printf %"$LONGEST_CHANNEL"s)
    printf '%s' "$CHANNEL: "
    printf '%.*s' $(($LONGEST_CHANNEL - ${#CHANNEL})) "$PAD"
    PAD=$(printf %"$LONGEST_NAME"s)
    printf '%s' "$NAME "
    printf '%.*s' $(($LONGEST_NAME - ${#NAME})) "$PAD"
    printf '%s\n' "$URL"
  else
    echo ""
  fi
done < $TMP_FILE

rm $TMP_FILE

